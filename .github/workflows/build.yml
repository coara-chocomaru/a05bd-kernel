name: Build Kernel

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04
      options: --user root
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable 32-bit architecture
        run: |
          dpkg --add-architecture i386
          apt-get update

      - name: deconf
        run: |
          apt-get update
          apt-get install -y \
          debconf-utils
          
      - name: Preseed tzdata for Tokyo
        run: |
          echo "tzdata tzdata/Areas select Asia" | debconf-set-selections
          echo "tzdata tzdata/Zones/Asia select Tokyo" | debconf-set-selections

      - name: tzdata
        run: |
            apt-get install -y tzdata \
            --no-install-recommends \
            -o Dpkg::Options::="--force-confdef" \
            -o Dpkg::Options::="--force-confold"
      
      - name: Set up APT packages
        run: |
          apt-get update
          apt-get install -y \
          git gnupg flex bison gperf build-essential zip curl \
          zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev \
          x11proto-core-dev libx11-dev lib32z-dev ccache libgl1-mesa-dev \
          libxml2-utils xsltproc unzip python3 python3-pip lib32z1 lib32stdc++6 libssl-dev \
          libswitch-perl swig maven libncurses5 xxd bc vim

      - name: Prepare and run build
        shell: bash
        run: |
          set -euo pipefail

          WORKDIR="$(pwd)"
          mkdir -p build
          cd build
          WORKSPACE_DIR="$(pwd)"
          WORKSPACE_OUT_DIR="${WORKSPACE_DIR}/out"
          TOOLCHAIN_BASE_DIR="${WORKSPACE_DIR}/toolchain"
          PLATFORM_EXTRACT_DIR="${WORKSPACE_DIR}/src"

          mkdir -p "${WORKSPACE_OUT_DIR}" "${TOOLCHAIN_BASE_DIR}" "${PLATFORM_EXTRACT_DIR}"

          TOOLCHAIN_REPO="https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9"
          TOOLCHAIN_BRANCH="llvm-r383902b"
          TOOLCHAIN_NAME="aarch64-linux-android-4.9"
          TOOLCHAIN_DIR="${TOOLCHAIN_BASE_DIR}/${TOOLCHAIN_NAME}"

          if [ ! -d "${TOOLCHAIN_DIR}" ] || [ -z "$(ls -A "${TOOLCHAIN_DIR}")" ]; then
            git clone --single-branch -b "${TOOLCHAIN_BRANCH}" "${TOOLCHAIN_REPO}" "${TOOLCHAIN_DIR}" --depth=1 || true
            if [ -d "${TOOLCHAIN_DIR}" ]; then
              if [ "$(git -C "${TOOLCHAIN_DIR}" rev-parse --abbrev-ref HEAD 2>/dev/null || echo HEAD)" = "HEAD" ]; then
                git -C "${TOOLCHAIN_DIR}" checkout -b local-toolchain || true
              fi
            fi
          fi

          CLANG_DIR="${TOOLCHAIN_BASE_DIR}/clang"
          if [ ! -d "${CLANG_DIR}" ] || [ -z "$(ls -A "${CLANG_DIR}")" ]; then
            git clone --depth=1 --single-branch -b android-9.0.0_r6 https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 "${CLANG_DIR}" || true
            if [ -d "${CLANG_DIR}" ]; then
              if [ "$(git -C "${CLANG_DIR}" rev-parse --abbrev-ref HEAD 2>/dev/null || echo HEAD)" = "HEAD" ]; then
                git -C "${CLANG_DIR}" checkout -b local-clang || true
              fi
            fi
          fi

          CLANG_COMPILER_PATH=""
          if [ -x "${CLANG_DIR}/bin/clang" ]; then
            CLANG_COMPILER_PATH="${CLANG_DIR}"
          else
            for d in "${CLANG_DIR}"/*; do
              if [ -x "${d}/bin/clang" ]; then
                CLANG_COMPILER_PATH="${d}"
                break
              fi
            done
            if [ -z "${CLANG_COMPILER_PATH}" ]; then
              CLANG_COMPILER_PATH="${CLANG_DIR}"
            fi
          fi

          cat > build_kernel_config.sh <<'EOF'
                                       KERNEL_SUBPATH="kernel/mediatek/mt8168/4.14"
                                       DEFCONFIG_NAME="a05bd_defconfig"
                                       TARGET_ARCH="arm64"
                                       TOOLCHAIN_REPO="https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9"
                                       TOOLCHAIN_BRANCH="llvm-r383902b"
                                       TOOLCHAIN_NAME="aarch64-linux-android-4.9"
                                       TOOLCHAIN_PREFIX="aarch64-linux-android-"
                                       KERNEL_IMAGES="arch/arm64/boot/Image:arch/arm64/boot/Image.gz:arch/arm64/boot/Image.gz-dtb"
                                       CLANG_COMPILER_PATH="__CLANG_PATH__"
                                       EOF
          sed -i "s|__CLANG_PATH__|${CLANG_COMPILER_PATH}|g" build_kernel_config.sh

          cat > build_kernel.sh <<'EOF'
                                #!/bin/bash
                                set -euo pipefail
                                
                                TARGET_DIR="${1:-output}"
                                SCRIPT_BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
                                CONFIG_FILE="${SCRIPT_BASE_DIR}/build_kernel_config.sh"
                                PATCH_FILE="${SCRIPT_BASE_DIR}/platform_patch.txt"
                                
                                mkdir -p build
                                WORKSPACE_DIR="$(pwd)/build"
                                WORKSPACE_OUT_DIR="${WORKSPACE_DIR}/out"
                                TOOLCHAIN_DIR="${WORKSPACE_DIR}/toolchain"
                                PLATFORM_EXTRACT_DIR="${WORKSPACE_DIR}/src"
                                OUTPUT_CFG="${WORKSPACE_OUT_DIR}/.config"
                                
                                for d in "${TOOLCHAIN_DIR}" "${PLATFORM_EXTRACT_DIR}" "${WORKSPACE_OUT_DIR}"
                                do
                                mkdir -p "${d}"
                                done
                                
                                PARALLEL_EXECUTION="-j$(nproc 2>/dev/null || echo 5)"
                                
                                function usage { echo "Usage: ${BASH_SOURCE[0]} path_to_platform_tar output_folder" 1>&2; exit 1; }
                                function validate_input_params {
                                if [[ ! -f "${CONFIG_FILE}" ]]
                                then
                                echo "ERROR: Could not find config file ${CONFIG_FILE}. Please check that you have extracted the build script properly and try again."
                                usage
                                fi
                                }
                                function display_config {
                                echo "-------------------------------------------------------------------------"
                                echo "SOURCE TARBALL: ${PLATFORM_TARBALL:-}"
                                echo "TARGET DIRECTORY: ${TARGET_DIR}"
                                echo "KERNEL SUBPATH: ${KERNEL_SUBPATH}"
                                echo "DEFINITION CONFIG: ${DEFCONFIG_NAME}"
                                echo "TARGET ARCHITECTURE: ${TARGET_ARCH}"
                                echo "TOOLCHAIN REPO: ${TOOLCHAIN_REPO}"
                                echo "TOOLCHAIN PREFIX: ${TOOLCHAIN_PREFIX}"
                                echo "-------------------------------------------------------------------------"
                                echo "Sleeping 1 second before continuing."
                                sleep 1
                                }
                                function setup_output_dir {
                                if [[ -d "${TARGET_DIR}" ]]
                                then
                                FILECOUNT=$(find "${TARGET_DIR}" -type f | wc -l)
                                if [[ ${FILECOUNT} -gt 0 ]]
                                then
                                echo "ERROR: Destination folder is not empty. Refusing to build to a non-clean target"
                                exit 3
                                fi
                                else
                                mkdir -p "${TARGET_DIR}"
                                fi
                                }
                                function download_toolchain {
                                echo "Cloning toolchain ${TOOLCHAIN_REPO} to ${TOOLCHAIN_DIR}"
                                git clone --single-branch -b "${TOOLCHAIN_BRANCH}" "${TOOLCHAIN_REPO}" "${TOOLCHAIN_DIR}" --depth=1
                                if [[ $? -ne 0 ]]
                                then
                                echo "ERROR: Could not clone toolchain from ${TOOLCHAIN_REPO}."
                                exit 2
                                fi
                                }
                                function download_toolchain2 {
                                echo "Cloning toolchain https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 to toolchain/clang"
                                git clone --single-branch -b android-9.0.0_r6 https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 "$(pwd)/toolchain/clang" --depth=1
                                if [[ $? -ne 0 ]]; then
                                echo "ERROR: Could not clone toolchain from https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86."
                                exit 2
                                fi
                                }
                                function extract_tarball {
                                echo "Extracting tarball to ${PLATFORM_EXTRACT_DIR}"
                                tar xf "${PLATFORM_TARBALL}" -C ${PLATFORM_EXTRACT_DIR}
                                }
                                function apply_patch {
                                if [[ -f "${PATCH_FILE}" ]]
                                then
                                echo "Applying patch to ${PLATFORM_EXTRACT_DIR}"
                                pushd ${PLATFORM_EXTRACT_DIR}
                                patch -p1 < ${PATCH_FILE}
                                popd
                                fi
                                }
                                function exec_build_kernel {
                                CCOMPILE="${TOOLCHAIN_DIR}/bin/${TOOLCHAIN_PREFIX}"
                                CC="${CLANG_COMPILER_PATH}/bin/clang"
                                if [[ -n "${KERNEL_SUBPATH}" ]]
                                then
                                MAKE_ARGS="-C ${KERNEL_SUBPATH}"
                                fi
                                MAKE_ARGS="-C ${KERNEL_SUBPATH} O=${WORKSPACE_OUT_DIR} ARCH=${TARGET_ARCH}"
                                MAKE_ARGS1="-C ${KERNEL_SUBPATH} O=${WORKSPACE_OUT_DIR} ARCH=${TARGET_ARCH} CROSS_COMPILE=${CCOMPILE} CLANG_TRIPLE=aarch64-linux-gnu- CC=${CC}"
                                pushd "${PLATFORM_EXTRACT_DIR}"
                                make ${MAKE_ARGS} ${DEFCONFIG_NAME} || true
                                if [[ -f "${OUTPUT_CFG}" ]]; then
                                cat "${OUTPUT_CFG}"
                                else
                                echo ".config not found yet (this is normal if defconfig didn't create it)"
                                fi
                                make ${PARALLEL_EXECUTION} ${MAKE_ARGS1}
                                popd
                                }
                                function copy_to_output {
                                pushd "${WORKSPACE_OUT_DIR}"
                                find "./arch/${TARGET_ARCH}/boot" -type f | sed 's/^\.\///' | while read CPFILE
                                do
                                BASEDIR="$(dirname "${CPFILE}")"
                                if [[ ! -d "${TARGET_DIR}/${BASEDIR}" ]]
                                then
                                mkdir -p "${TARGET_DIR}/${BASEDIR}"
                                fi
                                cp -v "${CPFILE}" "${TARGET_DIR}/${CPFILE}"
                                done
                                popd
                                }
                                function validate_output {
                                local IFS=":"
                                for IMAGE in ${KERNEL_IMAGES};do
                                if [ ! -f ${TARGET_DIR}/${IMAGE} ]; then
                                echo "ERROR: Missing kernel output image ${IMAGE}" >&2
                                exit 1
                                fi
                                ls -l ${TARGET_DIR}/${IMAGE}
                                done
                                }
                                validate_input_params
                                source "${CONFIG_FILE}"
                                setup_output_dir
                                TARGET_DIR="$(cd "${TARGET_DIR}" && pwd)"
                                display_config
                                if [ -n "${TOOLCHAIN_NAME}" ]; then
                                TOOLCHAIN_DIR="$(pwd)/toolchain/${TOOLCHAIN_NAME}"
                                fi
                                if [ -z "$(ls -A ${TOOLCHAIN_DIR})" ]; then
                                download_toolchain
                                fi
                                if [ -z "$(ls -A $(pwd)/toolchain/clang)" ]; then
                                download_toolchain2
                                fi
                                apply_patch
                                exec_build_kernel
                                copy_to_output
                                validate_output
                                EOF
          chmod +x build_kernel.sh
          ./build_kernel.sh output || true

      - name: Upload build output
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: ./output
