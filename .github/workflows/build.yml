name: Build Kernel

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:20.04
      options: --user root
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Aggressively remove all MODVERSIONS references and Module.symvers (destructive)
      id: wipe_modversions
      shell: bash
      run: |
        set -euo pipefail

        echo "== destructive MODVERSIONS purge: start =="

        mapfile -t FILES < <(grep -RIl --exclude-dir=".git" --exclude-dir=".repo" --exclude-dir=".github" --exclude-dir="output" "MODVERSIONS" . || true)

        if [ "${#FILES[@]}" -eq 0 ]; then
          echo "No MODVERSIONS occurrences found."
        else
          echo "Files to sanitize (${#FILES[@]}):"
          for f in "${FILES[@]}"; do
            echo "  - $f"
            # remove any line containing MODVERSIONS (case-insensitive)
            sed -i '/MODVERSIONS/Id' "$f"
          done
        fi

        grep -RIl --exclude-dir=".git" --exclude-dir=".repo" --exclude-dir=".github" --exclude-dir="output" "^CONFIG_MODVERSIONS" . || true
        find . -type f \( -name ".*" -o -name "*" \) -print0 \
          | xargs -0 -n1 -P4 bash -c 'sed -n q "$0" >/dev/null 2>&1 && sed -i "/^CONFIG_MODVERSIONS[[:space:]]*=/Id" "$0"' --

        echo "Removing Module.symvers files (if any)..."
        git ls-files --error-unmatch Module.symvers >/dev/null 2>&1 && git rm -f Module.symvers || true
        find . -type f -name Module.symvers -exec rm -f {} \; || true

        git add -A
        if ! git diff --cached --quiet; then
          git commit -m "CI: remove MODVERSIONS references and Module.symvers (destructive)" || true
        else
          echo "No changes to commit."
        fi

        if [ -f Makefile ]; then
          echo "Makefile found: running make olddefconfig to refresh .config"
          make olddefconfig || true
        fi

        echo "== destructive MODVERSIONS purge: done =="

    - name: Enable 32-bit architecture
      run: |
       dpkg --add-architecture i386
       apt-get update
      
    - name: deconf
      run: |
       apt-get update
       apt-get install -y \
       debconf-utils
       
    - name: Preseed tzdata for Tokyo
      run: |
       echo "tzdata tzdata/Areas select Asia" | debconf-set-selections
       echo "tzdata tzdata/Zones/Asia select Tokyo" | debconf-set-selections

    - name: tzdata
      run: |
       apt-get install -y tzdata \
            --no-install-recommends \
            -o Dpkg::Options::="--force-confdef" \
            -o Dpkg::Options::="--force-confold"

      
      

    - name: Set up APT packages
      run: |
        apt-get update
        apt-get install -y \
        git gnupg flex bison gperf build-essential zip curl \
        zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev \
        x11proto-core-dev libx11-dev lib32z-dev ccache libgl1-mesa-dev \
        libxml2-utils xsltproc unzip python lib32z1 lib32stdc++6 libssl-dev \
        libswitch-perl swig maven libncurses5 xxd bc vim

    - name: Set up clang
      run: |
        cd /__w/a05bd-kernel/a05bd-kernel
        mkdir -p toolchain/clang/clang-4691093
        curl -L https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/android-9.0.0_r6/clang-4691093.tar.gz | tar xz -C toolchain/clang/clang-4691093
        mkdir -p toolchain/aarch64-linux-android-4.9/
        git clone https://github.com/Adrilaw/aarch64-linux-android-4.9-toolchain/ -b master
        cp -rf aarch64-linux-android-4.9-toolchain/* toolchain/aarch64-linux-android-4.9/
    - name: Execute build script
      run: |
        chmod +x ./build_kernel.sh
        ./build_kernel.sh output

    - name: Upload build output
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: ./output
